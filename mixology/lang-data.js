export const AS_IS=e=>e,CONST=e=>()=>e;export class LazyArray{constructor(e,t=AS_IS){const r=new Array(e);r.get=t?Symbol.iterator in t?(s=t[Symbol.iterator](),n=r.buf=[],e=>{for(let t;s&&n.length<=e;n.push(t.value))(t=s.next()).done&&(s=null);return n[e]}):t:AS_IS;var s,n;return new Proxy(Object.freeze(r),this)}get(e,t,s,n){return r(t)&&(n=Number.parseInt(t))<e.length?e.get(n):Reflect.get(e,t,s)}has(e,t){return r(t)&&t<e.length||Reflect.has(e,t)}}export const isSameArray=(e,t)=>e===t||e.length===t.length&&e.every(((e,r)=>e===t[r]));export const loopFor=(e,t,r=0)=>{for(;r<t;)e(r++)};export function*newLoopGetter(e=0,t=AS_IS){for(let r=0;;r=0)for(;r<e;)yield t(r++)}export function*newLoopArray(e){yield*newLoopGetter(e.length,(t=>e[t]))}const e=/\/([^/]+)\.[^/]+$/,t=/\s+at\s([^\s]+ \([^\)]+\)|http.+)/g;export function Stack(r){const s=r?r.stack:Error().stack;return{caller:()=>{const e=s.matchAll(t);return!r&&e.next(),e.next(),e.next().value[1]},src:()=>s.match(e)[1]}}export const toJSON=(e,t=new Map([[NaN,"0/0"],[1/0,"1/0"],[-1/0,"1/-0"],[void 0,"0[0]"]]))=>JSON.stringify(e,((e,r)=>t.get(r)||r));export const fromJSON=(e,t={"0/0":NaN,"1/0":1/0,"1/-0":-1/0,"0[0]":void 0})=>JSON.parse(e,((e,r)=>r in t?t[r]:r));export const msg=(e,t=100)=>{if(null==e)return void 0===e?"?":"-";switch(null==e?null:typeof e){case"class":case"function":return e.name||`(${e})`;case"object":if(Symbol.iterator in e){const r=[];for(const s of e){if(r.length>=t)return`[${r.join(", ")}...]`;r.push(msg(s))}return`[${r.join(", ")}]`}return e instanceof WModel?String(e):`{${Object.entries(e).map((([e,t])=>`${msg(e)}:${msg(t)}`)).join(", ")}}`;default:return String(e)}};const r=e=>"symbol"!=typeof e;export const compareAsc=(e,t)=>e>t?1:e<t?-1:e==t?0:compareAsc(String(e),String(t));export const compareDesc=(e,t)=>compareAsc(t,e);export const compareArray=(e,t,r)=>(e.find(((e,s)=>r=compareAsc(e,t[s]))),r);export const compareBy=(e,t=compareAsc)=>(r,s)=>t(e(r),e(s));class s{static bound=(e,t,r,s)=>{let n=e=>s(r[e]),o=r.length,l=n(o-1)>=e?0:NaN,a=n(0)<=t?o:NaN;for(let t,r,s=a;l<s;)e>(t=n(r=l+s>>1))?l=r+1:s=r;for(let e,r,s=isNaN(l)?0:l;s<a;)t<(e=n(r=s+a>>1))?a=r:s=r+1;return[l,a]};get n(){const{nullIdx:e}=this._,t=e.length;return e[t-1]-t+1}get min(){return this._.min}get max(){return this._.max}get range(){return this.max-this.min}get sortIndex(){const{_:e}=this;return e.sidx||=Object.freeze(e.nullIdx.reduce(((e,t)=>(loopFor((t=>e.push(t)),t,e[e.length-1]),e)),[]).sort(compareBy(e.get)))}rowsOf(e,t=e){const r=this.sortIndex,[n,o]=s.bound(e,t,r,this._.get),l=o-n;return l?new LazyArray(l,(e=>r[e+n])):[]}rowsBy(e){const t=this.sortIndex,[r,n]=s.bound(e,e,t,this._.get);return r===n?[t[r-1],t[n]]:isNaN(r)?[t[n-1],null]:isNaN(n)?[null,t[r]]:(e=>[e,e])(t[r])}}class n{constructor(e,t,r){let s=0,n=0;for(let r,o=0;o<t;o++)null!=(r=e(o))&&(r?s++:n++);this._={true:s,false:n,n:t,by:r}}get n(){return this.true+this.false}get true(){return this._.true}get false(){return this._.false}get mean(){return this.true/this.n}}class o extends s{static estimate(e,t,r=.5){return(t-e)*r+e}constructor(e,t,r){super();let s=0,n=[],o=NaN,l=NaN,a=NaN,i=NaN,c=e=>{s=1,o=i=a=e,l=0,c=e=>{const t=e-o,r=t/++s;o+=r,l+=(s-1)*t*r,e>i?i=e:e<a&&(a=e)}};for(let r,s=0;s<t;s++)Number.isFinite(r=e(s))||Number.isFinite(r=Number(r))?c(r):n.push(s);n.push(t),this._={get:e,by:r,nullIdx:n,avg:o,var:s>1?l/(s-1):l,min:a,max:i}}get sum(){const e=this.n;return e?this.mean*e:0}get mean(){return this._.avg}get variance(){return this._.var}get stdDev(){return Math.sqrt(this.variance)}get median(){const e=this.sortIndex,t=e.length,r=t>>1,s=(n=this._.get,t=>n(e[t]));var n;return 1&t?s(r):(s(r)+s(r-1))/2}get q1(){return this.percentile(25)}get q3(){return this.percentile(75)}percentile(e){const t=this.sortIndex,r=t.length,s=e*(r+1)/100,n=~~s,l=(a=this._.get,e=>a(t[e]));var a;return s<1?l(0):s>=r?l(r-1):o.estimate(l(n-1),l(n),s-n)}}class l extends s{constructor(e,t,r){super();let s,n,o=[],l=(e,t)=>(n=s=[e,t],l=(e,t)=>e>n[0]&&(n=[e,t])||e<s[0]&&(s=[e,t]));for(let r,s=0;s<t;s++)Number.isFinite(r=e(s))||Number.isFinite(r=Date.parse(r))?l(r,s):o.push(s);o.push(t),this._=s?{get:e,by:r,nullIdx:o,min:e(s[1]),max:e(n[1]),range:n[0]-s[0]}:{get:e,by:r,nullIdx:o}}get range(){return this._.range}get rangeType(){const e=this.range/864e5;return e>0?e>30?e>365?"year":"month":e>7?"week":"day":e>=695e-6?e>=.04167?"hour":"minute":"second"}}class a{constructor(e,t,r){const s=this._=new Map,n=(e,t=s.get(e))=>t?t.length:0;for(let r,n,o=0;o<t;o++)(n=s.get(r=e(o)))?n.push(o):s.set(r,[o]);s.by=r,s.nonNulls=(s.n=t)-n(null)-n(void 0)}get n(){return this._.nonNulls}get keys(){return this._.key||=Object.freeze([...this._.keys()])}get sortKeys(){return this._.skey||=Object.freeze([...this.keys].sort())}rowsOf(...e){const t=this._;return e.length<=1?Object.freeze(t.get(e[0]))||[]:e.reduce(((e,r)=>(e.push.apply(e,t.get(r)),e)),[])}get keyIndex(){const e=this._;return e.idx||=Object.freeze([...e.values()].reduce(((e,t,r)=>(t.forEach((t=>e[t]=r)),e)),new Array(e.n)))}get sortKeyIndex(){const e=this._;return e.sidx||=Object.freeze(this.sortKeys.reduce(((t,r,s)=>(e.get(r).forEach((e=>t[e]=s)),t)),new Array(e.n)))}}class c{constructor(e,t,r){const s=this._=[],n=s.row=function(e={}){for(const t of Object.getOwnPropertyNames(Object.getPrototypeOf(e)))e[t]=void 0;return e}();for(let r,o=0;o<t;o++)(n[r=e(o)]||=(s.push(r),[])).push(o);s.get=e,s.n=t,s.by=r}get n(){return this._.n}get keys(){return this._}get sortKeys(){return this._.skey||=Object.freeze([...this.keys].sort(compareArray))}rowsOf(...e){const{row:t}=this._;return e.length<=1?Object.freeze(t[e[0]])||[]:e.reduce(((e,r)=>(e.push.apply(e,t[r]),e)),[])}get keyIndex(){const e=this._,{row:t}=e;return e.idx||=Object.freeze(e.reduce(((e,r,s)=>(t[r].forEach((t=>e[t]=s)),e)),new Array(this.n)))}get sortKeyIndex(){const e=this._,{row:t}=e;return e.sidx||=Object.freeze(this.sortKeys.reduce(((e,r,s)=>(t[r].forEach((t=>e[t]=s)),e)),new Array(this.n)))}}export class SumRange extends s{constructor(e,t,r){super();const s=this._={get:e,n:t,by:r,add:e=>{s.nonNulls=1,s.min=s.max=e,s.add=e=>{s.nonNulls++,e>s.max?s.max=e:e<s.min&&(s.min=e)}}};if(e)for(let r=0;r<t;r++)this.add(e(r))}get n(){return this._.nonNulls}add(e){null!=e&&this._.add(e)}append(e){for(const t of e)null!=t&&this._.add(t)}}const u=/[^\d]\d+[^\d]/,h={typeOf:e=>{return void 0===e?void 0:"string"===(t=typeof e)&&Date.parse(e)&&u.test(e)?"date":t;var t},typeBy(e){try{return this.typeOf(e())}catch(e){return}},keysOf:e=>[...Object.keys(e),...Object.getOwnPropertySymbols(e)],entryOf:e=>h.keysOf(e).map((t=>[t,e[t]])),fun:(e,t)=>({type:e,get:t,map:!0}),row:(e,t,r)=>{return h.fun(e,(e=>(s=t[e])?s[r]:null));var s},col:(e,t)=>({type:e,get:t.get||(e=>t[e]),map:!0,array:t}),map:(e,t)=>{return r=t.get,{type:t.type,get:t=>null==(t=e[t])?null:r(t),map:{row:e,col:t}};var r},fix:(e,t)=>({type:e,get:CONST(t),map:!1}),trans:(e,t)=>({type:"any",get:r=>e[r](t),map:!1}),id:{type:"number",get:AS_IS,map:!0},copy:(e,t,r,s=(e=>r.get(e)||t._col(e)))=>{for(let n=0,o=e.length;n<o;n++){const o=e[n],l=typeof o;"function"===l?o(r,s):"object"===l?h.keysOf(o).forEach((e=>r.set(e,s(o[e])))):"*"===o?t.fields.forEach((e=>r.set(e,s(e)))):(r.delete(o),r.set(o,s(o)))}return r}};export const JOIN_HISTORY={};export class WModel{constructor(e,t,r=null,s=null){this._rows=e,this._cols=t,this._meta=r,this._col=(r=>s=>{if(Array.isArray(s))return(r.tuple||={})[msg(s)]||=h.fun("array",WModel._arrayOf(s.map((e=>this._col(e).get))));if(null==s||"object"==typeof s)throw TypeError(`field "${msg(s)}" should be string, symbol, number or boolean`);let n,o,l=r.get(s);if(!l){if(!(n=t.get(s)))throw EvalError(`field "${msg(s)}" not found in ${msg([...t.keys()])}`);r.set(s,l=Array.isArray(o=n.map)?((t=o.row,s=r.get(t))=>(!s&&r.set(t,s=e.map(t[i].get||(e=>t[e]))),h.map(s,o.col)))():h.map(e,n))}return l})(Number.isInteger(e)?t:new Map),s&&(this._json=s),Object.preventExtensions(this)}static _sumClass={boolean:n,number:o,date:l,range:SumRange,array:c};static _arrayOf=e=>t=>e.map((e=>e(t)));static _callOf=(e,t,r)=>{const s=r.flat().map((e=>t(e).get)),n=s.length;return n>1||Array.isArray(r[0])?(l=WModel._arrayOf(s),t=>e(t,l(t))):0==n?t=>e(t):(o=s[0],t=>e(t,o(t)));var o,l};static _schema=(e=>e._meta=e)(new WModel(2,new Map([["field",h.col("string",["field","type"])],["type",h.col("string",["primitive","string"])]])));static fromJson(e){if(!e||!e.fields)throw SyntaxError(`Invalid JSON format: ${e}`);const{fields:t,kind:r,items:s}=e,n=t.length,o=Array.isArray(r)?r:new Array(n),l=s||[],a=new Map;if(n!==o.length)throw RangeError(`fields${msg(t)}=${n} but kind.length=${o.length}`);if(Array.isArray(l))return i=l[0]||l,t.forEach(((e,t,r)=>(r=Array.isArray(i)?t:e,a.set(e,h.row(o[t]||h.typeOf(i[r]),l,r))))),new WModel(l.length,a,null,e);var i;for(let e,r,s=0;s<n;s++){if(!(r=l[e=t[s]]))throw SyntaxError(`items[${e}] required (got {${Object.keys(l)}} only)`);a.set(e,"function"==typeof r?h.fun(o[s]||h.typeBy(r),r):h.col(o[s]||h.typeOf(r[0]),r))}return new WModel(l[t[0]].length,a,null,e)}static fromCSV(e,t=","){const r=new RegExp(`(${t}|\n|\r\n?|^)(?:"([^"]*(?:""[^"]*)*)"|([^${t}\r\n]*))`,"g"),s=/""/g,n=[],o=[];let l=n;for(const[,n,a,i]of e.trim().matchAll(r))n.length&&n!==t&&l.length&&o.push(l=[]),l.push(a?a.replace(s,'"'):i);return WModel.fromJson({fields:n,items:o})}static fromObject(e){return e instanceof Error?WModel.fromJson({fields:["Error","Code"],kind:["string","string"],items:e.stack.split(/\n\s*/).map(((e,t)=>(e.startsWith("at ")?(t=e.lastIndexOf("("))>0||(t=e.lastIndexOf(" http"))>0:(t=e.indexOf(": "))>0)?[e.substr(0,t),e.substr(t)]:[e]))}):WModel.fromJson({fields:["key","value"],kind:["string","any"],items:Object.entries(e)})}static unionAll(e,...t){if(!Array.isArray(e)||!e.length)throw SyntaxError(`WModel.unionAll([${e}], ${msg(t)})`);const r=e.length,s=[],n=new Array(r),o=new Map,l=t.length?t.flat():e[0].fields;if(1===r)return e[0].doSelect(l).result();for(let t=0;t<r;t++)for(let r=e[t],o=n[t]=s.length,l=r.rows+o;o<l;o++)s[o]=t;return l.forEach((t=>{return o.set(t,(r=e.map((e=>e._col(t))),h.fun(r[0].type,(l=r.map(((e,t)=>((e,t)=>r=>t(r-e))(n[t],e.get))),e=>{const t=l[s[e]];if(t)return t(e);throw RangeError(`get #${e} out of ${s.length} rows`)}))));var r,l})),new WModel(s.length,o)}static isAssignable(e){return null==e||e instanceof WModel}static isSameRows(e,t,r=null){if(!e)return!t;if(!t||e.rows!==t.rows)return!1;if(r){if(!Array.isArray(r))throw TypeError(`fields "${msg(r)}" should be Array`)}else r=e.fields;return t.forEach((s=e.toArrays(r),(e,t)=>{return!((r=s[e])===(n=t)||r.length===n.length&&r.every(((e,t)=>e===n[t])));var r,n}),r)<0;var s}static autoJoin(e){const t=Object.entries(e),r=!t.every(((e,t)=>(t=e[1])instanceof WModel||t&&(e[1]=WModel.autoJoin(t.join).result(...t.keep||[])))),s=WModel.fromJson({fields:["name","model"],items:t}).doSelect("name").formula("model",((e,[t,r])=>r.doSelect("*").rowId(`${t}.#`).result()),"name","model").result();if(r||s.rows<=1)return{source:e,dimension:s.doSelect("*").const("keys",[]).result(),steps:()=>r?s.toPartial(0):s,result:CONST(null)};const n=s.toSingle("model").reduce(((e,t)=>(t.fields.forEach((t=>e[t]=++e[t]||1)),e)),{}),o=s.query("rule",(e=>e.doSelect("name","model").formula(["keys","non-keys"],((e,[t,r])=>((e=[...t.fields].sort().reduce(((e,t)=>(e[n[t]>1?0:1].push(t),e)),[[],[]]))[0].set=new Set(e[0]),e)),"model","name")),(e=>e.doOrderBy(["keys","model"],compareBy((e=>e.length)),compareBy((e=>e.rows))))),l=o.toObjects();if(!l[0].keys.length)throw new ReferenceError(`資料無關聯性: ${l.filter((({keys:e})=>!e.length)).map((({name:e})=>e))}`);JOIN_HISTORY[Stack().caller()]=l;const a=(e,t)=>{const r=[t.name,e.name].flat(),s=new Set([...t.keys,...e.keys]),n=[...s];return n.set=s,{name:r,keys:n,model:[t,e]}},i=[...l].filter(((e,t,r)=>{const s=r.findIndex(((r,s,n)=>s>t&&(n=r.keys.set,e.keys.every((e=>n.has(e))))));return-1===s||!(r[s]=a(e,r[s]))}));for(;i.length>2;){const e=i.shift(),t=e.keys.set,r=i.map((({keys:e})=>e.reduce(((e,r)=>e+t.has(r)?1:0),0))),s=Math.max(...r),n=r.findIndex((e=>e==s));i[n]=a(e,i[n])}const c=1===i.length?i[0]:a(i[0],i[1]),u=({model:e},{model:t})=>e.fields.reduce(((e,r)=>(e[t.hasCols(r)?0:1].push(r),e)),[[],[]]),h=(...e)=>{const t=[],r=e.reduce(((e,t)=>(e[t]=null,e)),{}),s=e=>{if(!Array.isArray(e.model))return e;const n=e.name,o=e.model.map(s),l=u(...o)[0],[a,i]=!(o[1].name in r)||o[0].name in r&&o[0].model.rows>o[1].model.rows?o:o.reverse(),[c,h]=o.map((({name:e})=>e in r)),f=(c||h)&&(r[n]=!0),[y,d]=o.map((({model:e})=>e.doSummary(l))),m=[],p=[],g=(e,t)=>e.forEach((e=>t.forEach((t=>(m.push(e),p.push(t))))));y.keys.forEach(((e,t)=>((t=d.rowsOf(e)).length||c)&&g(y.rowsOf(e),t.length?t:[null])));const w=t.length+1,b=m.length,_=i.model.toArrays(...l);h&&d.keys.forEach((e=>y.rowsOf(e).length||g([null],d.rowsOf(e))));const A=a.model.toPartial(m).doSelect("*"),x=(m.length>b?A.formula(l,((e,t)=>e<b?t:_[p[e]]),...l):A).model(i.model.toPartial(p),...u(i,a)[1]).result();return t.push([[w,x,f,n],[w,a.model,c,a.name],[w,i.model,h,i.name]]),{name:n,model:x}};s(c);return WModel.fromJson({fields:["turn","model","keep","name"],items:t.reverse().flat(1)})};return{source:e,dimension:o,steps:h,result:(...e)=>h(...e).toSingle("model")[0]}}get schema(){return this._meta||=this.toTranspose()}get fields(){const e=this._cols;return e.fields||=Object.freeze([...e.keys()])}get cols(){return this._cols.size}get rows(){return Number.isInteger(this._rows)?this._rows:this._rows.length}debug(e=null,t=100){return console.log(e,this),console.table(this.toObjects().slice(0,Math.min(999,t))),this}hasCols(...e){const t=this._cols;for(const r of e)if(!t.has(r))return!1;return!0}getType(e){return this._col(e).type}forEach(e,...t){for(let r=0,s=this.rows,n=WModel._callOf(e,this._col,t);r<s;r++)if(!0===n(r))return r;return-1}query(e,...t){if("function"==typeof e)throw SyntaxError(`1st argument of query(${msg(e)}) should be purpose`);let r=this;for(let s,n=0,o=t.length;n<o;n++)try{if((s=t[n])&&(!(r=s(r))||!(r instanceof WModel||r.result&&(r=r.result())instanceof WModel)))throw TypeError(`result #${n} of [${e}] must be WModel`)}catch(t){throw SyntaxError(`failed on #${n} of [${e}]: ${t}`)}return r}doWhere(e,...t){const r=WModel._callOf(e,this._col,t),s=[];for(let e=0,t=this.rows;e<t;e++)r(e)&&s.push(e);return this.toPartial(s)}doOrderBy(e,...t){if(!Array.isArray(e))throw TypeError(`1st argument of doOrderBy(${msg(e)}) must be Array`);return this.rows>1?this.toPartial(function(e){const t=new Array(e);for(let r=0;r<e;r++)t[r]=r;return t}(this.rows).sort((r=t.flat(),s=this._col,n=e.map(((e,t)=>{const n=(l=s(e).get,(e,t)=>null==(t=l(e))?"":t),o=r[t];var l;return compareBy(n,"function"==typeof o?o:o?compareDesc:compareAsc)})),(e,t,r)=>(n.find((s=>r=s(e,t))),r)))):this;var r,s,n}doSelect(...e){const t=e.flat(),r=this,s=r.rows,n={select(...e){return t.push.apply(t,e.flat()),this},array(e,t,r=null){if(null==t||t.length!==s)throw TypeError(`select.array("${msg(e)}") required array.length=${s} but ${t?t.length:0})`);return this.select((s=>s.set(e,h.col(r||h.typeOf(t[0]),t))))},model(e,...t){if(e instanceof WModel&&e.rows===s)return this.select((r=>h.copy(t,e,r,(t=>e._col(t)))));throw TypeError(`select.model(${e}, ${msg(t)}) required model.rows=${s}`)},formula:(e,t,...r)=>n.select(((n,o)=>{const l=1!==(u=r.flat().map((e=>o(e).get))).length||Array.isArray(r[0])?WModel._arrayOf(u):u[0],a=(c=new Array(s),e=>e in c?c[e]:e<0||e>s?null:c[e]=t(e,l(e),a)),i=Array.isArray(e);var c,u;(i?e:e="object"==typeof e?h.entryOf(e):[e]).forEach(i||e.length>1?(e,t)=>Array.isArray(e)?n.set(e[0],h.fun(e[1],(e=>a(e)[t]))):n.set(e,h.fun(h.typeBy((()=>a(0)[t])),(e=>a(e)[t]))):e=>Array.isArray(e)?n.set(e[0],h.fun(e[1],a)):n.set(e,h.fun(h.typeBy((()=>a(0))),a)))})),pivot:(e,t)=>n.formula(e,((e,r)=>r.reduce(((e,r)=>((e[t[r]]||=[]).push(r),e)),[])),"#"),random:(e,t,r=(Array.isArray(t)?(e=>r=>t[~~(r*e)])(t.length):t))=>n.formula(e,(()=>r(Math.random()))),const:(e,t,r=null)=>n.select((s=>s.set(e,h.fix(r||h.typeOf(t),t)))),rowId:e=>n.select((t=>t.set(e,h.id))),delete:(...e)=>n.select((t=>e.forEach((e=>"function"==typeof e?[...t.keys()].filter(e).forEach((e=>t.delete(e))):t.delete(e))))),result:()=>new WModel(s,h.copy(t,r,new Map))};return n}doSummary(e,t=null){const r=this._col(e),s=t||r.type;return r[s]||=new(WModel._sumClass[s]||a)(r.get,this.rows,e)}doGroupBy(...e){const t=e.flat(),r=this.doSummary(t),s=r.keys.map((e=>r.rowsOf(e)));return this.toPartial(s.map((([e])=>e))).doSelect(...t).array("#",s,"int[]").result()}doJoin(e,t,...r){const s=[],n=1!==(c=r.flat().map((e=>this._col(e).get))).length||Array.isArray(r[0])?WModel._arrayOf(c):c[0],o=[],l=new Map,a=this._col,i=Array.isArray(e);var c;for(let e=0,r=this.rows,l=0;e<r;e++)for(t(e,n(e),s);l<s.length;l++)o[l]=e;return this.fields.forEach((e=>l.set(e,h.map(o,a(e))))),(i?e:e="object"==typeof e?h.entryOf(e):[e]).forEach(i||e.length>1?(e,t)=>Array.isArray(e)?l.set(e[0],h.row(e[1],s,t)):l.set(e,h.row(h.typeOf(s[0][t]),s,t)):e=>Array.isArray(e)?l.set(e[0],h.col(e[1],s)):l.set(e,h.col(h.typeOf(s[0]),s))),new WModel(s.length,l)}toPartial(e){const{_rows:t,_cols:r,_meta:s}=this,n=Number.isInteger(t);return Array.isArray(e)?new WModel(n?e:e.map(t.get||(e=>t[e])),r,s):Number.isInteger(e)&&e!=this.rows?new WModel(n?Math.min(e,t):t.slice(0,e),r,s):this}toTranspose(...e){const t=this._cols,r=this.fields,s=r.map((e=>t.get(e))),n=e.length,o=new Map([["field",h.col("string",r)],["type",h.fun("string",(e=>s[e].type))]]);var l,a;return n&&(l=s.map((e=>e.get)),a=this._rows,(Number.isInteger(a)?e:e.map(a.get||(e=>a[e]))).forEach(((t,r)=>o.set(e[r],h.trans(l,t))))),new WModel(r.length,o,n?null:WModel._schema)}toSingle(e){return new LazyArray(this.rows,this._col(e).get)}toArrays(...e){const t=(e.length?e.flat():this.fields).map((e=>this._col(e).get));return new LazyArray(this.rows,WModel._arrayOf(t))}toObjects(...e){const t=e.length?e.flat():this.fields,r=t.map((e=>this._col(e).get)),s=r.length;return new LazyArray(this.rows,((e,n={})=>{for(let o=0;o<s;o++)n[t[o]]=r[o](e);return n}))}toJSON(e=!1){return((t=this.fields.filter(r),s=this.rows,n=this._col,o=(e?{}:new LazyArray(s,WModel._arrayOf(t.map((e=>n(e).get))))),l=t.map(e?(e,t)=>(t=n(e),o[e]=new LazyArray(s,t.get),t.type):e=>n(e).type))=>({fields:t,kind:l,items:o}))()}toBlob({cols:e=this.fields,alias:t=[],title:r="Sheet1",type:s="csv"}={}){const n=this.toArrays(e),o=this._col,l=/"/g;return"pdf"===s?jspdf.jsPDF({unit:"pt",format:"letter"}).setFont("unicode").autoTable({head:[e.flat()],body:n,margin:30,styles:{font:"unicode",lineWidth:.1}}).output("blob"):new Blob({*[Symbol.iterator](){if(yield new Uint8Array([239,187,191]),"xls"===s){yield'<?xml version="1.0"?>\n<Workbook xmlns="urn:schemas-microsoft-com:office:spreadsheet" xmlns:ss="urn:schemas-microsoft-com:office:spreadsheet">\n<Styles><Style ss:ID="W"><Alignment ss:WrapText="1"/></Style></Styles>',yield`\n<Worksheet ss:Name="${r}"><Table>`,yield'<Column ss:AutoFitWidth="1" ss:Width="80"/>'.repeat(e.length);const s="/><Cell ",a=[],i=e=>null==e?"":`ss:Formula="${e}"`,c=e=>e?`ss:StyleID="W" ss:Formula="&quot;${String(e).replaceAll(l,"&quot;")}&quot;"`:"";yield`\n<Row><Cell ${e.map(((e,r)=>(a[r]="number"===o(e).type?i:c,c(t[r]||e)))).join(s)}/></Row>`;for(const e of n)yield`\n<Row><Cell ${a.map(((t,r)=>t(e[r]))).join(s)}/></Row>`;yield"\n</Table></Worksheet></Workbook>"}else{const r="csv"===s?",":"\t",o=new RegExp(`^"|[${r}\n]`),a=e=>null==e?"":(e=String(e)).match(o)?`"${e.replaceAll(l,'""')}"`:e;yield`${e.map(((e,r)=>a(t[r]||e))).join(r)}`;for(const e of n)yield`\n${e.map(a).join(r)}`}}},{type:("xls"===s?"application/vnd.ms-excel":"text/plain")+";charset=UTF-8",encoding:"UTF-8"})}toString(){return`WModel(${this.cols}x${this.rows})`}}function f(e){const t=e.length,r=[];for(let s=0,n=-1,o=0;o<t;o++){const l=e[o];switch(l){case"\\":if(++o>=t)r.push(l);else{const t=e[o];switch(t){case",":break;case"Q":case"E":r.push(l);default:r.push(l)}r.push(t)}break;case"*":0==s&&r.push("."),r.push(l);break;case"?":r.push(0==s?".":l);break;case"!":r.push(n==o?"^":l);break;case".":case"(":case")":case"+":case"|":case"^":case"$":case"@":case"%":(0==s||"^"==l&&n==o)&&r.push("\\"),r.push(l);break;case"[":s++,n=o+1,r.push(l);break;case"]":s--,r.push(l);break;default:r.push(l)}}return r.join("")}export const glob2regex=(...e)=>"(^"+e.flat().map(f).filter(AS_IS).join("$)|(^")+"$)";